<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Horas Complementares ‚Äì UFBA</title>
  <style>
    /* ============== RESET & VARS ============== */
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --grad1:#667eea;--grad2:#764ba2;--bg:#f5f7fa;--bg2:#c3cfe2;--text:#1a202c;
      --panel-blue:#8c97ff;--panel-red:#ff5b5b;--panel-green:#48bb78;--panel-yellow:#f6ad55;--panel-gray:#a0aec0;
      --font-s:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
    }
    body{font-family:var(--font-s);background:linear-gradient(135deg,var(--bg) 0%,var(--bg2) 100%);min-height:100vh;padding:20px;color:var(--text)}
    h1,h2,h3{font-weight:300}
    /* ============== CONTAINER & PANELS ============== */
    .container{max-width:1200px;margin:0 auto;background:#fff;border-radius:22px;box-shadow:0 25px 55px rgba(0,0,0,.07);overflow:hidden}
    header{background:linear-gradient(135deg,var(--grad1) 0%,var(--grad2) 100%);color:#fff;text-align:center;padding:34px 20px}
    header h1{font-size:2.35em;margin-bottom:4px}
    .main{display:grid;grid-template-columns:1fr 1fr;gap:32px;padding:28px}
    @media(max-width:850px){.main{grid-template-columns:1fr}}
    .panel{padding:24px;border-radius:18px}
    .form-panel{background:#f8faff;border-left:6px solid var(--panel-blue)}
    .list-panel{background:#fff5f5;border-left:6px solid var(--panel-red)}
    .progress-panel{background:#f0fff4;border-left:6px solid var(--panel-green);padding:26px 30px}
    /* ============== FORMS & INPUTS ============== */
    h2{color:#5661d1;font-size:1.45em;margin-bottom:16px}
    .form-group{margin-bottom:16px}
    label{display:block;font-weight:600;margin-bottom:6px;color:#4a5568}
    select,input,textarea{width:100%;padding:10px 14px;border:2px solid #e2e8f0;border-radius:10px;font-size:15px;background:#fff;transition:border-color .25s}
    select:focus,input:focus,textarea:focus{outline:none;border-color:var(--panel-blue);box-shadow:0 0 0 3px rgba(140,151,255,.15)}
    button{border:none;padding:8px 20px;font-size:15px;border-radius:25px;margin:4px 10px 0 0;cursor:pointer;color:#fff;background:linear-gradient(135deg,var(--grad1) 0%,var(--grad2) 100%);transition:transform .2s}
    button:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(102,126,234,.35)}
    .btn-danger{background:var(--panel-red)}
    /* ============== CARDS & BADGES ============== */
    .card,.legend-card{background:#fff;border-left:4px solid var(--panel-blue);border-radius:12px;box-shadow:0 3px 10px rgba(0,0,0,.05);padding:14px;margin:9px 0}
    .legend-card{border-left-color:var(--panel-gray)}
    .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .title{font-weight:600;color:#2d3748;font-size:.95em;flex:1}
    .badge{background:var(--panel-blue);color:#fff;border-radius:14px;padding:3px 10px;font-size:.78em;font-weight:500}
    /* ============== PROGRESS BARS ============== */
    .row{margin:12px 0}
    .label{font-size:.9em;font-weight:600;margin-bottom:4px}
    .bg-bar{background:#e2e8f0;height:18px;border-radius:10px;overflow:hidden}
    .fill{height:100%;background:linear-gradient(90deg,var(--panel-green) 0%,#38b2ac 100%);border-radius:10px;transition:width .35s}
    /* ============== OTHER UI ============== */
    .suggestions{margin-top:20px;background:#fffdf4;border-left:6px solid var(--panel-yellow);border-radius:15px;padding:18px}
    .suggestion-item{background:#fff;border-left:3px solid var(--panel-yellow);border-radius:8px;padding:8px;margin:6px 0;font-size:.9em}
    .decision-box{margin-top:20px;background:#ebf8ff;border-left:6px solid #4299e1;border-radius:15px;padding:18px}
    .perfil-box,.flex-box{background:#e6fffa;border-left:6px solid #38b2ac;border-radius:15px;padding:14px;margin-top:20px}
    .perfil-option,.flex-option{margin-right:12px;font-size:.9em}
    .tag{display:inline-block;font-size:.75em;padding:3px 8px;border-radius:10px;background:#edf2f7;color:#4a5568;margin-left:4px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Sistema de Horas Complementares</h1>
      <p>Ci√™ncia da Computa√ß√£o ‚Äì UFBA</p>
    </header>

    <div class="main">
      <!-- ========== FORMULARIO ========= -->
      <section class="panel form-panel">
        <h2>üìù Adicionar Atividade</h2>
        <form id="activityForm">
          <div class="form-group">
            <label for="activityType">Tipo de Atividade:</label>
            <select id="activityType" required><option value="">Selecione‚Ä¶</option></select>
          </div>
          <div class="form-group" id="hoursGroup">
            <label for="hours">Horas Realizadas:</label>
            <input id="hours" type="number" min="1" required>
            <small id="hoursHint" style="display:none;color:#4a5568;font-size:.8em"></small>
          </div>
          <button type="submit">Adicionar</button><button type="button" class="btn-danger" onclick="clearAll()">Limpar Tudo</button>
        </form>
        <!-- PERFIL & FLEXIBILIDADE -->
        <div class="perfil-box">
          <h3 style="margin-bottom:6px;color:#256d6a">üéØ Meu Perfil</h3>
          <div id="perfilOptions"></div>
        </div>
        <div class="flex-box">
          <h3 style="margin-bottom:6px;color:#256d6a">‚è∞ Prefer√™ncia de Hor√°rio</h3>
          <div id="flexOptions"></div>
        </div>
      </section>

      <!-- ========== LISTA ========= -->
      <section class="panel list-panel">
        <h2>üìä Suas Atividades</h2>
        <div id="activities"></div>
        <div id="suggestions" class="suggestions" style="display:none;">
          <h3>üí° Alertas & Sugest√µes</h3>
          <div id="suggestionsList"></div>
        </div>
        <div id="decisionBox" class="decision-box" style="display:none;"></div>
      </section>
    </div>

    <!-- ========== PROGRESS ========= -->
    <section class="progress-panel">
      <h2>üìà Progresso das Horas Complementares</h2>
      <div id="progressBars"></div>
      <div id="legendBox"></div>
    </section>
  </div>

<script>
/*****************************************
 * 1.  DADOS B√ÅSICOS (Dom√≠nio & Limites) *
 *****************************************/
const LIMITE_OUTRAS = 100; // categoria 2
const perfisEnum = { social: 'Social', mercado: 'Mercado', academico: 'Acad√™mico', geral: 'Geral' };
const flexibilidadeLabels = {
  flexivel: 'üè† Flex√≠vel',
  'meio-flexivel': 'üè´ Meio‚Äëflex√≠vel',
  rigido: '‚è∞ R√≠gido'
};

// === Cat√°logo de Atividades ===
// flexibilidade: define quando/onde a atividade pode ser realizada
// valorFixo: se existir, horas obrigat√≥rias por ocorr√™ncia
const atividades = [
  /* ======= EXTENS√ÉO ======= */
  { nome: "ACCS", categoria: "extensao", maxHoras: 100, valorFixo: null, perfil: "Social", comprovacao: "Comprovante de carga hor√°ria cumprida", flexibilidade: "meio-flexivel", score: 0 },
  { nome: "Est√°gio supervisionado", tipo:"estagio", categoria: "extensao", maxHoras: 100, valorFixo: 50, perfil: "Mercado", comprovacao: "Plano e relat√≥rio assinados", flexibilidade: "rigido", score: 0 },
  { nome: "Programa de Extens√£o", categoria: "extensao", maxHoras: 120, valorFixo: 60, perfil: "Social", comprovacao: "Comprovante SIATEX-UFBA", flexibilidade: "meio-flexivel", score: 0 },
  { nome: "Projeto de Extens√£o", categoria: "extensao", maxHoras: 120, valorFixo: 60, perfil: "Social", comprovacao: "Comprovante SIATEX-UFBA", flexibilidade: "meio-flexivel", score: 0 },
  { nome: "Curso de Extens√£o", categoria: "extensao", maxHoras: 120, valorFixo: null, perfil: "Acad√™mico", comprovacao: "Certificado ou SIATEX", flexibilidade: "flexivel", score: 0 },
  { nome: "Atividade de Campo", categoria: "extensao", maxHoras: 100, valorFixo: null, perfil: "Social", comprovacao: "Certificado atividade de campo", flexibilidade: "rigido", score: 0 },
  { nome: "Evento Acad√™mico-Cient√≠fico (participa√ß√£o)", tipo: "eventoAcademico", categoria: "extensao", categoriasAlternativas:["pesquisa"], maxHoras: 100, valorFixo: 50, perfil: "Acad√™mico", comprovacao: "Comprovante de participa√ß√£o", flexibilidade: "rigido", score: 0 },
  { nome: "Publica√ß√£o / Produto Acad√™mico", categoria: "extensao", categoriasAlternativas:["pesquisa"], maxHoras: 100, valorFixo: 50, perfil: "Acad√™mico", comprovacao: "Comprovante da publica√ß√£o", flexibilidade: "flexivel", score: 0 },
  { nome: "Organiza√ß√£o de Evento", tipo:"organizacaoEvento", categoria: "extensao", maxHoras: 100, valorFixo: 50, perfil: "Acad√™mico", comprovacao: "Comiss√£o organizadora", flexibilidade: "rigido", score: 0 },
  { nome: "Presta√ß√£o de Servi√ßo √† Comunidade", categoria: "extensao", maxHoras: 100, valorFixo: 50, perfil: "Social", comprovacao: "Comprovante de servi√ßo", flexibilidade: "meio-flexivel", score: 0 },
  { nome: "Liga Acad√™mica", categoria: "extensao", maxHoras: 120, valorFixo: 60, perfil: "Acad√™mico", comprovacao: "Certificado de participa√ß√£o", flexibilidade: "meio-flexivel", score: 0 },
  { nome: "Empresa J√∫nior", tipo:"empresaJunior", categoria: "extensao", maxHoras: 120, valorFixo: 60, perfil: "Mercado", comprovacao: "Certificado EJ", flexibilidade: "meio-flexivel", score: 0 },
  { nome: "Movimento Estudantil / Coletivos", categoria: "extensao", maxHoras: 120, valorFixo: 60, perfil: "Social", comprovacao: "Certificado de gest√£o", flexibilidade: "meio-flexivel", score: 0 },
  { nome: "Open-source externo (localiza√ß√£o / issues)", categoria: "extensao", maxHoras: 30, valorFixo: 10, perfil: "Mercado", comprovacao: "Aceite no issue tracker", flexibilidade: "flexivel", score: 0 },
  //{ nome: "Voluntariado educacional tecnol√≥gico", categoria: "extensao", maxHoras: 20, valorFixo: "50% da carga do certificado", perfil: "Social", comprovacao: "Certificado ‚â•10h", flexibilidade: "meio-flexivel", score: 0 },


  /* ======= OUTRAS ‚Äì ENSINO ======= */
  { nome: "Monitoria", tipo: "monitoria", categoria: "ensino", maxHoras: 30, valorFixo: 20, perfil: "Acad√™mico", comprovacao: "Certificado (‚â•20h)", flexibilidade: "rigido", score: 0 },
  { nome: "PET / GET (Educa√ß√£o Tutorial)", tipo:"pet", categoria: "ensino", maxHoras: 30, valorFixo: 20, perfil: "Acad√™mico", comprovacao: "Certificado (‚â•20h)", flexibilidade: "meio-flexivel", score: 0 },
  { nome: "Grupo de Estudo", tipo:"grupoEstudo", categoria: "ensino", maxHoras: 30, valorFixo: 10, perfil: "Acad√™mico", comprovacao: "Certificado (‚â•20h)", flexibilidade: "meio-flexivel", score: 0 },

  /* ======= OUTRAS ‚Äì PESQUISA ======= */
  { nome: "Inicia√ß√£o Cient√≠fica", tipo:"iniciacaoCientifica", categoria: "pesquisa", maxHoras: 30, valorFixo: 20, perfil: "Acad√™mico", comprovacao: "Certificado (‚â•20h)", flexibilidade: "meio-flexivel", score: 0 },
  { nome: "Estudo Secund√°rio (Revis√£o/Mapeamento)", categoria: "pesquisa", maxHoras: 30, valorFixo: 10, perfil: "Acad√™mico", comprovacao: "Declara√ß√£o orientador", flexibilidade: "flexivel", score: 0 },
  { nome: "Apresenta√ß√£o de Trabalho em Evento", categoria: "pesquisa", categoriasAlternativas:["extensao"], maxHoras: 30, valorFixo: 10, perfil: "Acad√™mico", comprovacao: "Comprovante de apresenta√ß√£o", flexibilidade: "rigido", score: 0 },
  { nome: "Artigo em Peri√≥dico", tipo:"artigoPeriodico", categoria: "pesquisa", categoriasAlternativas:["extensao"], maxHoras: 30, valorFixo: 30, perfil: "Acad√™mico", comprovacao: "C√≥pia da publica√ß√£o", flexibilidade: "flexivel", score: 0 },
  { nome: "Artigo em Confer√™ncia N/I", tipo:"artigoConferencia", categoria: "pesquisa", categoriasAlternativas:["extensao"], maxHoras: 30, valorFixo: 20, perfil: "Acad√™mico", comprovacao: "C√≥pia dos anais", flexibilidade: "flexivel", score: 0 },
  { nome: "Artigo em Confer√™ncia Regional", categoria: "pesquisa", categoriasAlternativas:["extensao"], maxHoras: 30, valorFixo: 20, perfil: "Acad√™mico", comprovacao: "C√≥pia dos anais", flexibilidade: "flexivel", score: 0 },
  { nome: "Premia√ß√£o de Pesquisa", categoria: "pesquisa", maxHoras: 30, valorFixo: 20, perfil: "Acad√™mico", comprovacao: "Documento de premia√ß√£o", flexibilidade: "rigido", score: 0 },

  /* ======= OUTRAS ‚Äì VIV√äNCIA PROFISSIONAL ======= */
  { nome: "Gest√£o de Redes Acad√™micas", categoria: "vivencia", maxHoras: 30, valorFixo: 20, perfil: "Mercado", comprovacao: "Relat√≥rio professor", flexibilidade: "meio-flexivel", score: 0 },
  { nome: "Open-source STI/UFBA", categoria: "vivencia", maxHoras: 30, valorFixo: 10, perfil: "Mercado", comprovacao: "Declara√ß√£o orientador", flexibilidade: "flexivel", score: 0 },
  { nome: "Certifica√ß√£o T√©cnica", tipo:"certificacao", categoria: "vivencia", maxHoras: 30, valorFixo: 30, perfil: "Mercado", comprovacao: "Certificado oficial", flexibilidade: "flexivel", score: 0 },
  //{ nome: "Curso de Capacita√ß√£o Profissional", categoria: "vivencia", maxHoras: 30, valorFixo: "50% da carga do curso", perfil: "Mercado", comprovacao: "Certificado ou declara√ß√£o", flexibilidade: "flexivel", score: 0 },
  { nome: "Competi√ß√£o Acad√™mica (GRUPRO)", categoria: "vivencia", maxHoras: 60, valorFixo: 20, perfil: "Mercado", comprovacao: "Certificado de participa√ß√£o", flexibilidade: "rigido", score: 0 },
  { nome: "Participa√ß√£o em Olimp√≠ada / Maratona de Computa√ß√£o", categoria: "vivencia", maxHoras: 60, valorFixo: 20, perfil: "Mercado", comprovacao: "Certificado de participa√ß√£o", flexibilidade: "rigido", score: 0 },

  /* ======= OUTRAS ‚Äì EVENTOS T√âCNICOS CIENT√çFICOS ======= */
  { nome: "Congressos / Semanas / Workshops", tipo:"congresso", categoria: "eventos", maxHoras: 30, valorFixo: 10, perfil: "Acad√™mico", comprovacao: "Certificado participa√ß√£o", flexibilidade: "rigido", score: 0 },
  { nome: "Associa√ß√£o em Sociedade Cient√≠fica", categoria: "eventos", maxHoras: 10, valorFixo: 5, perfil: "Acad√™mico", comprovacao: "Carteira de s√≥cio", flexibilidade: "flexivel", score: 0 },
  { nome: "Premia√ß√£o em Olimp√≠ada/Maratona", categoria: "eventos", categoriasAlternativas:["vivencia"], maxHoras: 30, valorFixo: 10, perfil: "Acad√™mico", comprovacao: "Certificado de premia√ß√£o", flexibilidade: "rigido", score: 0 },

  /* ======= OUTRAS ‚Äì INTERVEN√á√ÉO ORGANIZACIONAL ======= */
  { nome: "Comiss√£o Organizadora de Evento", categoria: "organizacional", categoriasAlternativas:["extensao"], maxHoras: 30, valorFixo: 10, perfil: "Acad√™mico", comprovacao: "Certificado/declara√ß√£o", flexibilidade: "rigido", score: 0 },
  { nome: "Ministrante de Curso/Oficina", categoria: "organizacional", categoriasAlternativas:["extensao"], maxHoras: 30, valorFixo: 15, perfil: "Acad√™mico", comprovacao: "Certificado de ministrante", flexibilidade: "rigido", score: 0 },
  { nome: "Coordena√ß√£o de Congresso/Simp√≥sio", categoria: "organizacional", categoriasAlternativas:["extensao"], maxHoras: 30, valorFixo: 20, perfil: "Acad√™mico", comprovacao: "Certificado", flexibilidade: "rigido", score: 0 },
  { nome: "Desenvolvimento de Solu√ß√£o Tecnol√≥gica", categoria: "organizacional", maxHoras: 30, valorFixo: 20, perfil: "Mercado", comprovacao: "Registro/autoria", flexibilidade: "flexivel", score: 0 },
  { nome: "Atua√ß√£o Administrativa no Instituto", categoria: "organizacional", maxHoras: 30, valorFixo: 20, perfil: "Acad√™mico", comprovacao: "Relat√≥rio professor", flexibilidade: "rigido", score: 0 },

  /* ======= OUTRAS ‚Äì REPRESENTA√á√ÉO ESTUDANTIL ======= */
  { nome: "Mandato em CA/DA/DCE", categoria: "representacao", maxHoras: 30, valorFixo: 30, perfil: "Social", comprovacao: "Ata de posse + declara√ß√£o", flexibilidade: "meio-flexivel", score: 0 },
  { nome: "Representa√ß√£o em Colegiado/Departamento", tipo:"representacao", categoria: "representacao", maxHoras: 30, valorFixo: 30, perfil: "Social", comprovacao: "Ata de elei√ß√£o + declara√ß√£o", flexibilidade: "meio-flexivel", score: 0 },
  { nome: "Comiss√£o Eleitoral Estudantil", categoria: "representacao", maxHoras: 10, valorFixo: 5, perfil: "Social", comprovacao: "Ata de apura√ß√£o", flexibilidade: "rigido", score: 0 },
  { nome: "Representa√ß√£o em Sociedade Cient√≠fica", categoria: "representacao", maxHoras: 30, valorFixo: 30, perfil: "Acad√™mico", comprovacao: "Declara√ß√£o da sociedade", flexibilidade: "flexivel", score: 0 },

  /* ======= OUTRAS ‚Äì FORMA√á√ÉO INTERDISCIPLINAR ======= */
  { nome: "Curso de Idiomas (‚â• Intermedi√°rio)", categoria: "interdisciplinar", maxHoras: 30, valorFixo: 30, perfil: "Geral", comprovacao: "Certificado com carga", flexibilidade: "flexivel", score: 0 },
  { nome: "Certifica√ß√£o de Profici√™ncia", categoria: "interdisciplinar", maxHoras: 30, valorFixo: 20, perfil: "Acad√™mico", comprovacao: "Certificado oficial", flexibilidade: "flexivel", score: 0 },
  { nome: "Disciplina Optativa Externa", categoria: "interdisciplinar", maxHoras: 30, valorFixo: 30, perfil: "Acad√™mico", comprovacao: "Hist√≥rico escolar", flexibilidade: "rigido", score: 0 },

  /* ======= OUTRAS ‚Äì OUTROS ======= */
  { nome: "Atividade F√≠sica Orientada", categoria: "outros", maxHoras: 20, valorFixo: 5, perfil: "Geral", comprovacao: "Declara√ß√£o da academia", flexibilidade: "meio-flexivel", score: 0 },
  { nome: "Atividade Cultural", categoria: "outros", maxHoras: 20, valorFixo: 10, perfil: "Geral", comprovacao: "Declara√ß√£o da institui√ß√£o", flexibilidade: "flexivel", score: 0 },
  { nome: "Doa√ß√£o de Sangue", categoria: "outros", maxHoras: 15, valorFixo: 5, perfil: "Geral", comprovacao: "Atestado de doa√ß√£o", flexibilidade: "flexivel", score: 0 },
  { nome: "Mes√°rio em Elei√ß√£o Oficial", categoria: "outros", maxHoras: 10, valorFixo: 5, perfil: "Social", comprovacao: "Declara√ß√£o Justi√ßa Eleitoral", flexibilidade: "rigido", score: 0 }
];

// Limites por categoria 1 & 2 (resolu√ß√£o UFBA)
const limitesCat = { extensao: 330, ensino: 30, pesquisa: 30, vivencia: 30, eventos: 30, organizacional: 30, representacao: 30, interdisciplinar: 30, outros: 20 };
const nomesCat = { extensao: 'Extens√£o', ensino: 'Ensino', pesquisa: 'Pesquisa', vivencia: 'Viv√™ncia Profissionais', eventos: 'Eventos T√©cnicos', organizacional: 'Interven√ß√£o Organizacional', representacao: 'Representa√ß√£o Estudantil', interdisciplinar: 'Forma√ß√£o Interdisciplinar', outros: 'Outros' };

/*****************************************
 * 2.  REGRAS DE ASSOCIA√á√ÉO (Apriori-like)
 *****************************************/
// Mapeia chave da atividade ‚Üí atividades recomendadas
const regrasCombinacao = {
  monitoria: ['iniciacaoCientifica', 'grupoEstudo', 'pet'],
  iniciacaoCientifica: ['monitoria', 'artigoPeriodico', 'artigoConferencia', 'congresso'],
  pet: ['monitoria', 'grupoEstudo', 'iniciacaoCientifica'],
  estagio: ['empresaJunior', 'certificacao'],
  empresaJunior: ['estagio', 'organizacaoEvento', 'certificacao'],
  representacao: ['organizacaoEvento', 'eventoAcademico', 'accs'],
  artigoPeriodico: ['artigoConferencia', 'congresso', 'iniciacaoCientifica'],
  certificacao: [ 'estagio', 'empresaJunior'],
  organizacaoEvento: ['representacao', 'empresaJunior', 'eventoAcademico']
};

/*****************************************
 * 3.  ESTADO & UTILIT√ÅRIOS             *
 *****************************************/
let registros = [];           // Atividades cadastradas
let pendente = null;          // Atividade aguardando decis√£o de categoria
let perfisMarcados = [];      // Perfis de interesse
let flexPrefs = [];           // Prefer√™ncias de flexibilidade
let alertas = [];

// ---- Fun√ß√µes de An√°lise de Dados ---- //
// 3.1  SUMARIZA√á√ÉO ‚Äì total por categoria (dashboard)
function summariseData() {
  const obj = {};
  Object.keys(limitesCat).forEach(c => (obj[c] = 0));
  registros.forEach(r => (obj[r.categoria] += r.horas));
  return obj;
}

// 3.2  CLASSIFICA√á√ÉO ‚Äì dado um id de atividade, obter seu perfil & flexibilidade
function classifyActivity(key) {
  const a = atividades[key];
  atividades.forEach(r => {
    if (r.categoria==a.categoria) r.score+=2;
    if (r.perfil=="Geral") r.score+=1;
    if (perfisMarcados.includes(r.perfil)) r.score+=5;
    if (flexPrefs.includes(r.flexibilidade)) r.score+=4;
  });
}

// 3.3  ASSOCIA√á√ÉO ‚Äì gera lista de atividades relacionadas que ainda cabem
function associateSuggestions() {
  const feitas = registros.map(r => r.tipo);
  const relacionadas = new Set();
  feitas.forEach(t => {
    classifyActivity(t);
    tipo = atividades[t].tipo;
    if (regrasCombinacao[tipo]) regrasCombinacao[tipo].forEach(r => relacionadas.add(r));
  });
  // remove j√° feitas / sem horas / fora das prefs
  const soma = summariseData();
  const outrasTotal = Object.keys(soma).filter(c => c !== 'extensao').reduce((s, c) => s + soma[c], 0);
  return [...relacionadas].filter(filterAtv);
}
function filterAtv(k){
  const a = atividades.filter(r => r.tipo === k);
    // j√° atingiu m√°ximo?
    if (horasPorTipo(k) >= a.maxHoras) return false;
    return true;
}

function horasPorTipo(t) {
  return registros.filter(r => r.tipo === t).reduce((s, r) => s + r.horas, 0);
}

/*****************************************
 * 4.  BUILD / UI HELPERS               *
 *****************************************/
function buildSelect() {
  const sel = document.getElementById('activityType');
  const grupos = {};
  Object.entries(atividades).forEach(([k, a]) => {
    if (!grupos[a.categoria]) grupos[a.categoria] = [];
    grupos[a.categoria].push({ key: k, ...a });
  });
  Object.keys(grupos).forEach(cat => {
    const og = document.createElement('optgroup');
    grupos[cat].sort((x, y) => x.nome.localeCompare(y.nome)).forEach(a => {
      const op = document.createElement('option');
      op.value = a.key;
      op.textContent = `${a.nome}`;
      og.appendChild(op);
    });
    sel.appendChild(og);
  });
}

function buildPerfis() {
  const wrap = document.getElementById('perfilOptions');
  Object.entries(perfisEnum).forEach(([k, label]) => {
    const id = 'perfil_' + k;
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.id = id;
    cb.value = k;
    cb.addEventListener('change', () => {
      cb.checked ? perfisMarcados.push(k) : (perfisMarcados = perfisMarcados.filter(p => p !== k));
      updateSuggestions();
    });
    const lb = document.createElement('label');
    lb.htmlFor = id;
    lb.textContent = label;
    lb.className = 'perfil-option';
    wrap.appendChild(cb);
    wrap.appendChild(lb);
  });
}

function buildFlexPrefs() {
  const wrap = document.getElementById('flexOptions');
  Object.entries(flexibilidadeLabels).forEach(([k, label]) => {
    const id = 'flex_' + k;
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.id = id;
    cb.value = k;
    cb.addEventListener('change', () => {
      cb.checked ? flexPrefs.push(k) : (flexPrefs = flexPrefs.filter(f => f !== k));
      updateSuggestions();
    });
    const lb = document.createElement('label');
    lb.htmlFor = id;
    lb.textContent = label;
    lb.className = 'flex-option';
    wrap.appendChild(cb);
    wrap.appendChild(lb);
  });
}

function buildLegenda() {
 /*  const box = document.getElementById('legendBox');
  box.innerHTML =
    '<h3 style="font-weight:600;margin-bottom:8px">üìÑ Comprovantes</h3>' +
    Object.values(atividades)
      .map(a => {
        return `<div class="legend-card">
          <div class="card-header"><span class="title">${a.nome}</span></div>
          <div style="font-size:.82em"><strong>Categoria:</strong> ${nomesCat[a.categoria]}</div>
          <div style="font-size:.8em;color:#555"><strong>Comprovante:</strong> ${a.comprovacao}</div>
          <div style="font-size:.8em;color:#555"><strong>Flexibilidade:</strong> ${flexibilidadeLabels[a.flexibilidade]}</div>
          ${a.valorFixo ? `<div style="font-size:.8em;color:#256d6a;margin-top:4px"><strong>Horas fixas:</strong> ${a.valorFixo}h</div>` : ''}
        </div>`;
      })
      .join(''); */
}

/*****************************************
 * 5.  RENDER FUNCTIONS                 *
 *****************************************/
function renderActivities() {
  const c = document.getElementById('activities');
  if (!registros.length) {
    c.innerHTML = '<p style="color:#718096;font-style:italic;">Nenhuma atividade adicionada.</p>';
    return;
  }
  c.innerHTML = registros
    .map(a => {
      return `<div class="card">
        <div class="card-header">
          <span class="title">${a.nome}</span>
          <span class="badge">${a.horas}h</span>
          <button class="btn-danger" style="font-size:.8em;padding:3px 8px;border-radius:12px;margin-left:8px" onclick="del(${a.id})">√ó</button>
        </div>
        <div style="font-size:.8em"><strong>Categoria:</strong> ${nomesCat[a.categoria]} </div>
        <div style="font-size:.8em;color:#555"><strong>Comprovante:</strong> ${a.comprovacao}</div>
      </div>`;
    })
    .join('');
}

function renderProgress() {
  const h = summariseData();
  const total = Object.values(h).reduce((s, v) => s + v, 0);
  const p = document.getElementById('progressBars');
  p.innerHTML = `<div class="row"><div class="label">Total: ${total}/430h (${Math.round((total / 430) * 100)}%)</div><div class="bg-bar"><div class="fill" style="width:${Math.min((total / 430) * 100, 100)}%"></div></div></div>` +
    Object.keys(limitesCat)
      .map(cat => {
        const perc = Math.round((h[cat] / limitesCat[cat]) * 100);
        return `<div class="row"><div class="label">${nomesCat[cat]}: ${h[cat]}/${limitesCat[cat]}h (${perc}%)</div><div class="bg-bar"><div class="fill" style="width:${Math.min(perc, 100)}%"></div></div></div>`;
      })
      .join('');
}

function updateSuggestions() {
  const wrap = document.getElementById('suggestions');
  const list = document.getElementById('suggestionsList');
  const msgs = [...alertas];
  alertas.length = 0;

  // Excesso de horas por categoria
  const h = summariseData();
  Object.keys(h).forEach(c => {
    if (h[c] > limitesCat[c]) msgs.push(`‚ö†Ô∏è Excedeu <strong>${nomesCat[c]}</strong> em ${h[c] - limitesCat[c]}h. <br> `);
  });
  const outras = Object.keys(h).filter(c => c !== 'extensao').reduce((s, c) => s + h[c], 0);
  if (outras >= LIMITE_OUTRAS) msgs.push('üîí Categoria 2 completa (100h). Conclua apenas atividades de Extens√£o.<br> ');
  const ext = Object.keys(h).filter(c => c == 'extensao').reduce((s, c) => s + h[c], 0);
  if (ext >= 330) msgs.push('üîí Extens√£o completa (330h). Conclua apenas atividades da Categoria 2.<br> ');

  // Sugest√µes associativas
  const assoc = associateSuggestions();
  atvss=[...atividades].filter(filterAtv)
  if (assoc.length) { 
    msgs.push('<strong>Sugest√µes associadas:</strong><br>')
    assoc.map(k => {
      atv = atvss.filter(r => r.tipo === k)
      atv=atv[0]
      atv.score+=10
    })
    atvss.sort((a, b) => (a.score < b.score))
    atvss.filter(filterAtv)
    console.log(atvss)
    for(let i =0; i<5; i++){
      atv=atvss[i]
      pref = flexPrefs.filter(r => r == atv.flexibilidade)
      nome = atv.nome
      if ((atv.categoria =="extensao" && ext<330) || (atv.categoria !== "extensao" && outras<LIMITE_OUTRAS)){
        if (!pref.length) {
          msgs.push(`‚Ä¢ ${nome} <br> Esta atividade requer hor√°rio <span class="tag">${flexibilidadeLabels[atv.flexibilidade]}</span> que n√£o est√° nas suas prefer√™ncias.<br> `)
        } else {
          msgs.push(`‚Ä¢ ${nome} <br> `)
        }
      } 
    }
    msgs.join("")
  }
  wrap.style.display = msgs.length ? 'block' : 'none';
  list.innerHTML = msgs.map(m => `<div class="suggestion-item">${m}</div>`).join('');
}

function redraw() {
  renderActivities();
  renderProgress();
  updateSuggestions();
}

/*****************************************
 * 6.  DECISION BOX (Categoria din√¢mica)*
 *****************************************/
function showDecision(o) {
  const h = summariseData();
  const ord = [...o.opcoes].sort((a, b) => h[a] - h[b]);
  const box = document.getElementById('decisionBox');
  box.innerHTML = `<strong>Alocar "${o.nome}" (${o.horas}h):</strong><br>` +
    ord.map(c => `<button onclick="choose('${c}')">${nomesCat[c]}</button>`).join(' ') +
    ' <button class="btn-danger" onclick="hideDecision()">Cancelar</button>';
  box.style.display = 'block';
}
function hideDecision() { document.getElementById('decisionBox').style.display = 'none'; }
function choose(cat) {
  if (pendente) insert({ ...pendente, categoria: cat });
  pendente = null;
  hideDecision();
}

/*****************************************
 * 7.  CRUD OPERATIONS                  *
 *****************************************/
function insert(r) {
  registros.push(r);
  redraw();
}
function del(id) {
  registros = registros.filter(r => r.id !== id);
  redraw();
}
function clearAll() {
  registros = [];
  alertas = [];
  redraw();
  hideDecision();
}

/*****************************************
 * 8.  HOURS FIELD BEHAVIOR             *
 *****************************************/
const typeSel = document.getElementById('activityType');
const hoursInp = document.getElementById('hours');
const hoursHint = document.getElementById('hoursHint');
function adjustHoursField() {
  const key = typeSel.value;
  if (!key) {
    hoursInp.disabled = true;
    hoursInp.value = '';
    hoursHint.style.display = 'none';
    return;
  }
  const at = atividades[key];
  if (at.valorFixo) {
    hoursInp.disabled = true;
    hoursInp.required = false;
    hoursInp.value = at.valorFixo;
    hoursHint.textContent = `Horas fixas para esta atividade: ${at.valorFixo}h`;
    hoursHint.style.display = 'block';
  } else {
    hoursInp.disabled = false;
    hoursInp.required = true;
    hoursInp.value = '';
    hoursHint.style.display = 'none';
  }
}

typeSel.addEventListener('change', adjustHoursField);

/*****************************************
 * 9.  FORM SUBMIT                      *
 *****************************************/
document.getElementById('activityForm').addEventListener('submit', e => {
  e.preventDefault();
  const tipo = typeSel.value;
  if (!tipo) return;
  const at = atividades[tipo];
  let horas = parseInt(hoursInp.value || 0);
  if (at.valorFixo) horas = at.valorFixo;
  if (!horas || horas <= 0) { alert('Informe as horas.'); return; }

  // limite por tipo
  const ja = horasPorTipo(tipo);
  if (ja >= at.maxHoras) { alertas.push(`Limite ${at.maxHoras}h de "${at.nome}" j√° usado.`); redraw(); return; }
  if (horas + ja > at.maxHoras) {
    alertas.push(`S√≥ √© poss√≠vel adicionar at√© ${at.maxHoras - ja}h nesta atividade.`);
    horas = at.maxHoras - ja;
  }

  // categoria 2 limite
  const catTotal = summariseData();
  const outrasTotal = Object.keys(catTotal).filter(c => c !== 'extensao').reduce((s, c) => s + catTotal[c], 0);
  if (at.categoria !== 'extensao' && outrasTotal >= LIMITE_OUTRAS) {
    alertas.push('Categoria 2 completa. Apenas Extens√£o aceita.'); redraw(); return; }
  if (at.categoria !== 'extensao' && outrasTotal + horas > LIMITE_OUTRAS) {
    alertas.push(`Restam ${LIMITE_OUTRAS - outrasTotal}h na Categoria 2.`);
    redraw(); return;
  }

    // cextens√£o limite
  const extTotal = Object.keys(catTotal).filter(c => c == 'extensao').reduce((s, c) => s + catTotal[c], 0);
  if (at.categoria == 'extensao' && extTotal >= 330) {
    alertas.push('Extens√£o completa. Apenas Categoria 2 aceita.'); redraw(); return; }
  if (at.categoria == 'extensao' && extTotal + horas > 330) {
    alertas.push(`Restam ${330 - extTotal}h em Extens√£o.`);
    redraw(); return;
  }

  const opcoes = at.categoriasAlternativas ? [at.categoria, ...at.categoriasAlternativas] : [at.categoria];
  const base = {
    id: Date.now(),
    tipo,
    nome: at.nome,
    horas,
    comprovacao: at.comprovacao,
    flexibilidade: at.flexibilidade,
    opcoes
  };
  if (opcoes.length > 1) {
    pendente = base;
    showDecision(base);
  } else {
    insert({ ...base, categoria: at.categoria });
  }
  e.target.reset();
  adjustHoursField();
});

/*****************************************
 * 10.  INIT                            *
 *****************************************/
window.addEventListener('DOMContentLoaded', () => {
  buildSelect();
  buildPerfis();
  buildFlexPrefs();
  buildLegenda();
  adjustHoursField();
  redraw();
});
</script>
</body>
</html>
